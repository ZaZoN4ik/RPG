<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG 3.0: Cloud Sync</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #09090b;
            --accent: #f59e0b;
            --danger: #ef4444;
            --ui-bg: rgba(24, 24, 27, 0.95);
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* HEADER */
        .header {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            background: var(--ui-bg);
            border-bottom: 1px solid #333;
            z-index: 10;
        }
        .stat { font-size: 12px; font-weight: bold; color: #a1a1aa; text-align: center; }
        .stat span { font-size: 16px; color: var(--accent); display: block; }
        .sync-status { font-size: 10px; color: #555; position: absolute; top: 2px; right: 5px; }

        /* BOSS TIMER */
        .boss-panel {
            background: #3f3f46;
            padding: 5px;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            text-align: center;
        }
        .boss-timer-bar { height: 6px; background: #27272a; width: 100%; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .boss-timer-fill { height: 100%; background: var(--danger); width: 100%; transition: width 0.2s linear; }
        .boss-text { color: var(--danger); font-weight: bold; font-size: 14px; }

        /* ARENA */
        .arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: radial-gradient(circle, #27272a 0%, #09090b 70%);
        }

        .monster-box { position: relative; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; }
        .monster { font-size: 100px; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5)); cursor: pointer; transition: transform 0.05s; z-index: 2; }
        .monster:active { transform: scale(0.9); }
        
        /* –ü–∏—Ç–æ–º–µ—Ü */
        .pet { position: absolute; font-size: 40px; right: -20px; top: 20px; animation: float 3s infinite ease-in-out; z-index: 1; display: none; }

        /* HP BAR */
        .hp-wrapper { width: 80%; margin-top: 20px; text-align: center; }
        .hp-bar { height: 18px; background: #333; border-radius: 9px; overflow: hidden; position: relative; border: 2px solid #555; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #b91c1c); width: 100%; transition: width 0.1s; }
        
        /* CONTROLS */
        .controls { background: var(--ui-bg); height: 40%; display: flex; flex-direction: column; border-top: 1px solid #333; padding: 10px; }
        .skills { display: flex; gap: 10px; margin-bottom: 10px; }
        .skill-btn { flex: 1; background: #27272a; border: 1px solid #444; border-radius: 8px; padding: 10px; color: #fff; position: relative; overflow: hidden; font-weight: bold; }
        .skill-btn.ready { border-color: var(--accent); background: #3f3f46; cursor: pointer; }
        .skill-cd { position: absolute; bottom: 0; left: 0; height: 3px; background: #fff; width: 0%; }

        .upgrades { flex: 1; overflow-y: auto; }
        .upgrade-item { background: #27272a; margin-bottom: 8px; padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .upgrade-item.disabled { opacity: 0.5; pointer-events: none; }
        .btn-buy { background: var(--accent); color: #000; font-weight: bold; border: none; padding: 6px 12px; border-radius: 6px; }

        /* CHEST */
        .chest { position: absolute; font-size: 60px; top: 20%; left: -100px; animation: flyChest 4s linear forwards; z-index: 100; cursor: pointer; }

        .dmg-popup { position: absolute; font-weight: 900; font-size: 28px; pointer-events: none; animation: floatUp 0.6s forwards; text-shadow: 0 0 5px #000; color: white; z-index: 50; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes flyChest { 0% { left: -60px; } 100% { left: 110%; } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-60px); } }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus">Syncing...</div>

    <div class="boss-panel" id="bossPanel">
        <div class="boss-text">üî• –ë–û–°–°! <span id="bossTimeText">30</span> —Å–µ–∫</div>
        <div class="boss-timer-bar">
            <div class="boss-timer-fill" id="bossTimerFill"></div>
        </div>
    </div>

    <div class="header">
        <div class="stat">LVL <span id="ui-lvl">1</span></div>
        <div class="stat">DPS <span id="ui-dps">0</span></div>
        <div class="stat">GOLD <span id="ui-gold">0</span></div>
    </div>

    <div class="arena">
        <div class="monster-box">
            <div class="monster" id="monster" onclick="onTap(event)">ü¶†</div>
            <div class="pet" id="pet">ü¶Ö</div>
        </div>

        <div class="hp-wrapper">
            <div class="hp-bar">
                <div class="hp-fill" id="hpFill"></div>
            </div>
            <div style="margin-top:5px; font-size:12px; color:#aaa;">
                <span id="hpCur">10</span> / <span id="hpMax">10</span>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="skills">
            <button class="skill-btn" id="btnSkill" onclick="useSkill()">
                üí• –£–õ–¨–¢–ê
                <div class="skill-cd" id="skillCdBar"></div>
            </button>
        </div>

        <div class="upgrades">
            <div class="upgrade-item" id="upg-click" onclick="buy('click')">
                <div><b>‚öîÔ∏è –ú–µ—á</b><div style="font-size:10px; color:#aaa">+1 –∫ –∫–ª–∏–∫—É</div></div>
                <button class="btn-buy" id="cost-click">10</button>
            </div>
            <div class="upgrade-item" id="upg-auto" onclick="buy('auto')">
                <div><b>ü§ñ –ù–∞–µ–º–Ω–∏–∫</b><div style="font-size:10px; color:#aaa">+2 —É—Ä–æ–Ω–∞/—Å–µ–∫</div></div>
                <button class="btn-buy" id="cost-auto">50</button>
            </div>
            <div class="upgrade-item" id="upg-pet" onclick="buy('pet')">
                <div><b>ü¶Ö –ü–∏—Ç–æ–º–µ—Ü</b><div style="font-size:10px; color:#aaa">–£–¥–≤–∞–∏–≤–∞–µ—Ç DPS</div></div>
                <button class="btn-buy" id="cost-pet">500</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // --- –î–ê–ù–ù–´–ï –ò–ì–†–´ ---
        let game = {
            gold: 0,
            lvl: 1,
            clickDmg: 1,
            autoDmg: 0,
            hasPet: false,
            lastSave: Date.now()
        };
        
        let prices = { click: 10, auto: 50, pet: 500 };
        
        let monster = { hp: 10, maxHp: 10, isBoss: false };
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–æ–≥–∏–∫–∏
        let bossTimeLeft = 0;
        let bossInterval = null;
        let nextChestTime = Date.now() + 60000; // –ü–µ—Ä–≤—ã–π —Å—É–Ω–¥—É–∫ —á–µ—Ä–µ–∑ 60 —Å–µ–∫
        let skillCooldown = 0;

        // --- 1. –û–ë–õ–ê–ß–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï (Telegram CloudStorage) ---
        
        function loadGame() {
            document.getElementById('syncStatus').innerText = "Loading Cloud...";
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞ –¢–ì
            tg.CloudStorage.getItem('rpg_save_v3', (err, value) => {
                if (!err && value) {
                    try {
                        const data = JSON.parse(value);
                        game = data.game;
                        prices = data.prices;
                        
                        // AFK –¥–æ—Ö–æ–¥
                        const now = Date.now();
                        const secondsOffline = Math.floor((now - game.lastSave) / 1000);
                        if (secondsOffline > 60 && game.autoDmg > 0) {
                            const earned = Math.floor(secondsOffline * game.autoDmg * 0.5);
                            game.gold += earned;
                            tg.showAlert(`‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n–ü–æ–∫–∞ —Ç—ã –Ω–µ –∏–≥—Ä–∞–ª, –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${earned} –∑–æ–ª–æ—Ç–∞.`);
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞", e);
                    }
                } else {
                    // –ï—Å–ª–∏ –æ–±–ª–∞–∫–æ –ø—É—Å—Ç–æ–µ (–Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫), –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ–π–≤
                    console.log("Cloud empty or error");
                }
                
                // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                initLevel();
                updateUI();
                document.getElementById('syncStatus').innerText = "Online";
            });
        }

        function saveGame() {
            game.lastSave = Date.now();
            const dataStr = JSON.stringify({ game, prices });
            
            document.getElementById('syncStatus').innerText = "Syncing...";
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ
            tg.CloudStorage.setItem('rpg_save_v3', dataStr, (err, stored) => {
                if (err) {
                    document.getElementById('syncStatus').innerText = "Sync Error!";
                } else {
                    document.getElementById('syncStatus').innerText = "Saved";
                    setTimeout(() => document.getElementById('syncStatus').innerText = "Online", 2000);
                }
            });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(saveGame, 30000);


        // --- 2. –õ–û–ì–ò–ö–ê –ë–û–Ø ---

        function initLevel() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–æ—Å—Å–∞ (–∫–∞–∂–¥—ã–π 10 —É—Ä–æ–≤–µ–Ω—å)
            monster.isBoss = (game.lvl % 10 === 0);
            
            // –§–æ—Ä–º—É–ª–∞ –∑–¥–æ—Ä–æ–≤—å—è: 20 * 1.3^lvl. –ë–æ—Å—Å –≤ 5 —Ä–∞–∑ —Ç–æ–ª—â–µ.
            const baseHp = Math.floor(20 * Math.pow(1.25, game.lvl - 1));
            monster.maxHp = monster.isBoss ? baseHp * 5 : baseHp;
            monster.hp = monster.maxHp;

            // –í–∏–∑—É–∞–ª
            const emojis = ["ü¶†","üëπ","üë∫","üíÄ","üëª","üëΩ","ü§ñ","üßõ","üßü","üêâ"];
            const bossEmojis = ["ü¶ç","ü¶ñ","ü¶à","üëø"];
            document.getElementById('monster').innerText = monster.isBoss 
                ? bossEmojis[Math.floor(Math.random()*bossEmojis.length)] 
                : emojis[Math.floor(Math.random()*emojis.length)];

            // –õ–æ–≥–∏–∫–∞ –ë–æ—Å—Å–∞
            clearInterval(bossInterval);
            if (monster.isBoss) {
                startBossFight();
            } else {
                document.getElementById('bossPanel').style.display = 'none';
            }
            updateUI();
        }

        function startBossFight() {
            document.getElementById('bossPanel').style.display = 'block';
            bossTimeLeft = 30; // 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –±–æ—Å—Å–∞
            updateBossTimerUI();

            bossInterval = setInterval(() => {
                bossTimeLeft--;
                updateBossTimerUI();

                if (bossTimeLeft <= 0) {
                    // –í–†–ï–ú–Ø –í–´–®–õ–û!
                    clearInterval(bossInterval);
                    failBoss();
                }
            }, 1000);
        }

        function updateBossTimerUI() {
            document.getElementById('bossTimeText').innerText = bossTimeLeft;
            const pct = (bossTimeLeft / 30) * 100;
            document.getElementById('bossTimerFill').style.width = pct + "%";
        }

        function failBoss() {
            // –õ–µ—á–∏–º –±–æ—Å—Å–∞
            monster.hp = monster.maxHp; 
            updateUI();
            
            tg.HapticFeedback.notificationOccurred('error');
            tg.showAlert("‚è≥ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ë–æ—Å—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª –∑–¥–æ—Ä–æ–≤—å–µ.");
            
            // –†–µ—Å—Ç–∞—Ä—Ç —Ç–∞–π–º–µ—Ä–∞
            startBossFight(); 
        }

        function onTap(e) {
            // –†–∞—Å—á–µ—Ç —É—Ä–æ–Ω–∞
            let isCrit = Math.random() < 0.1; // 10% –∫—Ä–∏—Ç
            let dmg = game.clickDmg * (isCrit ? 2 : 1);
            
            dealDamage(dmg);
            
            // –≠—Ñ—Ñ–µ–∫—Ç—ã (–±–µ–∑ —á–∞—Å—Ç–∏—Ü, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∏ –≤–∏–±—Ä–∞—Ü–∏—è)
            spawnPopup(e.clientX, e.clientY, dmg, isCrit);
            if(isCrit) tg.HapticFeedback.impactOccurred('medium');
            else tg.HapticFeedback.impactOccurred('light');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è
            const m = document.getElementById('monster');
            m.style.transform = "scale(0.9)";
            setTimeout(() => m.style.transform = "scale(1)", 50);
        }

        function dealDamage(amount) {
            monster.hp -= amount;
            if (monster.hp <= 0) {
                monster.hp = 0;
                onDeath();
            }
            updateUI();
        }

        function onDeath() {
            clearInterval(bossInterval); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –±—ã–ª –±–æ—Å—Å
            document.getElementById('bossPanel').style.display = 'none';
            
            // –ù–∞–≥—Ä–∞–¥–∞
            const baseGold = Math.floor(monster.maxHp / 2.5);
            game.gold += monster.isBoss ? baseGold * 3 : baseGold;
            
            game.lvl++;
            tg.HapticFeedback.notificationOccurred('success');
            
            initLevel(); // –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
            saveGame(); // –°–µ–π–≤ –ø–æ—Å–ª–µ —É–±–∏–π—Å—Ç–≤–∞
        }

        // --- 3. –ê–í–¢–û-–£–†–û–ù –ò –°–£–ù–î–£–ö–ò ---
        setInterval(() => {
            // Auto Damage (—Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
            if (game.autoDmg > 0) {
                let dps = game.autoDmg * (game.hasPet ? 2 : 1);
                dealDamage(dps);
            }

            // –°—É–Ω–¥—É–∫–∏ (–†–∞–∑ –≤ 1-2 –º–∏–Ω—É—Ç—ã)
            const now = Date.now();
            if (now >= nextChestTime) {
                spawnChest();
                // –°–ª–µ–¥—É—é—â–∏–π —Å—É–Ω–¥—É–∫ —á–µ—Ä–µ–∑ 60-120 —Å–µ–∫—É–Ω–¥
                const delay = 60000 + Math.random() * 60000;
                nextChestTime = now + delay;
            }

        }, 1000);

        function spawnChest() {
            const chest = document.createElement('div');
            chest.className = 'chest';
            chest.innerText = "üéÅ";
            document.body.appendChild(chest);

            chest.onclick = () => {
                const bonus = Math.max(50, game.clickDmg * 100);
                game.gold += bonus;
                spawnPopup(100, 200, `+${bonus} GOLD`, true);
                chest.remove();
                tg.HapticFeedback.notificationOccurred('success');
            };

            setTimeout(() => chest.remove(), 4000); // –ò—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 4 —Å–µ–∫
        }

        // --- 4. –ù–ê–í–´–ö–ò –ò –ú–ê–ì–ê–ó–ò–ù ---
        function useSkill() {
            if (skillCooldown > 0) return;
            
            const dmg = game.clickDmg * 20; // –£–¥–∞—Ä x20
            dealDamage(dmg);
            spawnPopup(window.innerWidth/2, window.innerHeight/2, "BOOM!", true);
            tg.HapticFeedback.notificationOccurred('warning');

            // –ö—É–ª–¥–∞—É–Ω 30 —Å–µ–∫
            skillCooldown = 30;
            const btn = document.getElementById('btnSkill');
            btn.classList.remove('ready');
            
            const cdInt = setInterval(() => {
                skillCooldown--;
                const w = ((30 - skillCooldown) / 30) * 100;
                document.getElementById('skillCdBar').style.width = w + "%";
                
                if (skillCooldown <= 0) {
                    clearInterval(cdInt);
                    btn.classList.add('ready');
                }
            }, 1000);
        }

        function buy(type) {
            const cost = prices[type];
            if (game.gold >= cost) {
                game.gold -= cost;
                
                if (type === 'click') {
                    game.clickDmg++;
                    prices.click = Math.floor(prices.click * 1.5);
                } else if (type === 'auto') {
                    game.autoDmg += 2;
                    prices.auto = Math.floor(prices.auto * 1.4);
                } else if (type === 'pet') {
                    if (game.hasPet) return;
                    game.hasPet = true;
                    prices.pet = 999999;
                    document.getElementById('upg-pet').classList.add('disabled');
                }
                updateUI();
                tg.HapticFeedback.selectionChanged();
            } else {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // --- UI UTILS ---
        function updateUI() {
            document.getElementById('ui-gold').innerText = game.gold;
            document.getElementById('ui-lvl').innerText = game.lvl;
            document.getElementById('ui-dps').innerText = game.autoDmg * (game.hasPet ? 2 : 1);
            
            // HP Bar
            const hpPct = (monster.hp / monster.maxHp) * 100;
            document.getElementById('hpFill').style.width = hpPct + "%";
            document.getElementById('hpCur').innerText = Math.floor(monster.hp);
            document.getElementById('hpMax').innerText = monster.maxHp;

            // –ö–Ω–æ–ø–∫–∏
            document.getElementById('cost-click').innerText = prices.click;
            document.getElementById('cost-auto').innerText = prices.auto;
            
            // –ü–∏—Ç–æ–º–µ—Ü
            document.getElementById('pet').style.display = game.hasPet ? 'block' : 'none';
            
            // –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
            checkBtn('cost-click', 'upg-click');
            checkBtn('cost-auto', 'upg-auto');
            if(!game.hasPet) checkBtn('cost-pet', 'upg-pet');
        }

        function checkBtn(costId, boxId) {
            const val = parseInt(document.getElementById(costId).innerText);
            const box = document.getElementById(boxId);
            if (game.gold >= val) box.style.opacity = "1";
            else box.style.opacity = "0.5";
        }

        function spawnPopup(x, y, text, isCrit) {
            const el = document.createElement('div');
            el.className = 'dmg-popup';
            el.innerText = text;
            el.style.left = (x + (Math.random()-0.5)*30) + "px";
            el.style.top = (y - 50) + "px";
            if (isCrit) el.style.color = "#ef4444";
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        // –°–¢–ê–†–¢
        loadGame(); // –ì—Ä—É–∑–∏–º –∏–∑ –æ–±–ª–∞–∫–∞

    </script>
</body>
</html>
