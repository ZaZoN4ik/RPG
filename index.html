<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG 2.0: Boss Update</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #09090b;
            --accent: #f59e0b;
            --danger: #ef4444;
            --rare: #a855f7;
            --ui-bg: rgba(24, 24, 27, 0.95);
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            transition: background 1s ease;
        }

        /* –ê–ù–ò–ú–ê–¶–ò–ò –§–û–ù–ê (–õ–æ–∫–∞—Ü–∏–∏) */
        .bg-forest { background: radial-gradient(circle, #14532d, #022c22); }
        .bg-cave { background: radial-gradient(circle, #3f3f46, #18181b); }
        .bg-hell { background: radial-gradient(circle, #7f1d1d, #450a0a); }

        /* HEADER */
        .header {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            background: var(--ui-bg);
            border-bottom: 1px solid #333;
            z-index: 10;
        }
        .stat { font-size: 12px; font-weight: bold; color: #a1a1aa; display: flex; flex-direction: column; align-items: center; }
        .stat span { font-size: 16px; color: var(--accent); margin-top: 2px; }

        /* BOSS TIMER */
        .boss-timer-container {
            height: 4px;
            background: #333;
            width: 100%;
            display: none; /* –°–∫—Ä—ã—Ç, –ø–æ–∫–∞ –Ω–µ –±–æ—Å—Å */
        }
        .boss-timer-fill {
            height: 100%;
            background: var(--danger);
            width: 100%;
            transition: width 1s linear;
        }

        /* ARENA */
        .arena {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .monster-box { position: relative; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; }
        .monster { font-size: 100px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); transition: transform 0.1s; z-index: 2; cursor: pointer; }
        .monster:active { transform: scale(0.9); }
        
        /* –ü–∏—Ç–æ–º–µ—Ü */
        .pet {
            position: absolute;
            font-size: 40px;
            right: -20px;
            top: 20px;
            animation: float 3s infinite ease-in-out;
            z-index: 1;
            display: none;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ö–û–ú–ë–û (–û–≥–æ–Ω—å) */
        .combo-fire {
            position: absolute;
            bottom: -20px;
            width: 100%;
            height: 100px;
            background: linear-gradient(to top, rgba(239, 68, 68, 0.4), transparent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* HP BAR */
        .hp-wrapper { width: 80%; margin-top: 20px; text-align: center; }
        .hp-bar { height: 16px; background: #333; border-radius: 8px; overflow: hidden; position: relative; border: 2px solid #444; }
        .hp-fill { height: 100%; background: var(--danger); width: 100%; transition: width 0.1s; }
        .boss-label { color: var(--danger); font-weight: 900; letter-spacing: 2px; display: none; margin-bottom: 5px; animation: pulse 1s infinite; }

        /* SKILLS & MENU */
        .controls {
            background: var(--ui-bg);
            height: 40%;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #333;
            padding: 10px;
        }

        /* Skill Bar */
        .skills { display: flex; gap: 10px; margin-bottom: 10px; }
        .skill-btn {
            flex: 1;
            background: #27272a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px;
            color: #fff;
            position: relative;
            overflow: hidden;
        }
        .skill-btn.ready { border-color: var(--accent); background: #3f3f46; }
        .skill-cd { position: absolute; bottom: 0; left: 0; height: 3px; background: #fff; width: 0%; transition: width 0.1s linear; }

        /* Upgrades List */
        .upgrades { flex: 1; overflow-y: auto; }
        .upgrade-item {
            background: #27272a;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .upgrade-item.disabled { opacity: 0.5; }
        .btn-buy { background: var(--accent); color: #000; font-weight: bold; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; }

        /* FLYING CHEST */
        .chest {
            position: absolute;
            font-size: 50px;
            top: 20%;
            left: -100px;
            animation: flyChest 5s linear forwards;
            z-index: 20;
            cursor: pointer;
        }

        /* PARTICLES */
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            pointer-events: none;
            animation: fadeOut 0.5s forwards;
        }

        .dmg-popup {
            position: absolute;
            font-weight: 900;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 0.8s forwards;
            text-shadow: 0 0 3px #000;
            color: white;
            z-index: 100;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes flyChest { 0% { left: -50px; } 100% { left: 110%; } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-80px); } }
        @keyframes fadeOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: translate(var(--mx), var(--my)) scale(0); } }

    </style>
</head>
<body class="bg-forest">

    <div class="boss-timer-container" id="bossTimerBox">
        <div class="boss-timer-fill" id="bossTimerBar"></div>
    </div>

    <div class="header">
        <div class="stat">LVL <span id="ui-lvl">1</span></div>
        <div class="stat">DPS <span id="ui-dps">0</span></div>
        <div class="stat">GOLD <span id="ui-gold">0</span></div>
    </div>

    <div class="arena" id="arena">
        <div class="combo-fire" id="comboFire"></div>
        
        <div class="monster-box">
            <div class="monster" id="monster" onclick="onTap(event)">ü¶†</div>
            <div class="pet" id="pet">ü¶Ö</div>
        </div>

        <div class="hp-wrapper">
            <div class="boss-label" id="bossLabel">‚ö†Ô∏è BOSS FIGHT ‚ö†Ô∏è</div>
            <div class="hp-bar">
                <div class="hp-fill" id="hpFill"></div>
            </div>
            <div style="margin-top:5px; font-size:12px; color:#aaa;">
                <span id="hpCur">10</span> / <span id="hpMax">10</span>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="skills">
            <button class="skill-btn" id="btnSkill" onclick="useSkill()">
                üî• –£–õ–¨–¢–ê
                <div class="skill-cd" id="skillCdBar"></div>
            </button>
        </div>

        <div class="upgrades">
            <div class="upgrade-item" id="upg-click" onclick="buy('click')">
                <div>
                    <div style="font-weight:bold;">‚öîÔ∏è –û—Å—Ç—Ä—ã–π –º–µ—á</div>
                    <div style="font-size:10px; color:#aaa;">+1 —É—Ä–æ–Ω –∫ –∫–ª–∏–∫—É</div>
                </div>
                <button class="btn-buy" id="cost-click">10 üí∞</button>
            </div>
            
            <div class="upgrade-item" id="upg-auto" onclick="buy('auto')">
                <div>
                    <div style="font-weight:bold;">ü§ñ –ù–∞–µ–º–Ω–∏–∫</div>
                    <div style="font-size:10px; color:#aaa;">+2 —É—Ä–æ–Ω–∞ / —Å–µ–∫</div>
                </div>
                <button class="btn-buy" id="cost-auto">50 üí∞</button>
            </div>

            <div class="upgrade-item" id="upg-pet" onclick="buy('pet')">
                <div>
                    <div style="font-weight:bold;">ü¶Ö –ü–∏—Ç–æ–º–µ—Ü</div>
                    <div style="font-size:10px; color:#aaa;">–ü–æ–º–æ–≥–∞–µ—Ç –≤ –±–æ—é (x2 DPS)</div>
                </div>
                <button class="btn-buy" id="cost-pet">500 üí∞</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- CONFIG ---
        const MONSTERS = ["ü¶†", "üëπ", "üíÄ", "üë∫", "üê∫", "üëª", "üßõ", "üßü", "üï∑Ô∏è", "üêâ"];
        const BOSSES = ["ü¶ç", "ü¶à", "ü¶ñ", "üëø"];
        
        // --- STATE ---
        let game = {
            gold: 0,
            lvl: 1,
            clickDmg: 1,
            autoDmg: 0,
            hasPet: false,
            lastSave: Date.now()
        };

        let prices = { click: 10, auto: 50, pet: 500 };
        
        let monster = { hp: 10, maxHp: 10, isBoss: false };
        let bossTimer = null;
        let skillCooldown = 0;
        let comboCounter = 0;
        let comboTimer = null;

        // --- LOAD GAME & AFK ---
        if(localStorage.getItem('rpg_v2')) {
            const data = JSON.parse(localStorage.getItem('rpg_v2'));
            game = data.game;
            prices = data.prices;
            
            // AFK Calculation
            const now = Date.now();
            const diffSec = Math.floor((now - game.lastSave) / 1000);
            if(diffSec > 60 && game.autoDmg > 0) {
                const earned = Math.floor(diffSec * game.autoDmg * 0.5); // 50% efficiency offline
                game.gold += earned;
                tg.showAlert(`üí§ –ü–æ–∫–∞ —Ç—ã —Å–ø–∞–ª, –Ω–∞–µ–º–Ω–∏–∫–∏ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${earned} –∑–æ–ª–æ—Ç–∞!`);
            }
        }
        
        initLevel();
        updateUI();

        // --- GAME LOOP (1 sec) ---
        setInterval(() => {
            // Auto Damage
            if(game.autoDmg > 0) {
                let dmg = game.autoDmg;
                if(game.hasPet) dmg *= 2; // Pet bonus
                dealDamage(dmg, false);
            }
            // Save
            game.lastSave = Date.now();
            localStorage.setItem('rpg_v2', JSON.stringify({game, prices}));
            
            // Chest Spawn (5% chance)
            if(Math.random() < 0.05 && !document.querySelector('.chest')) spawnChest();

        }, 1000);

        // --- CLICK HANDLER ---
        function onTap(e) {
            e.preventDefault();
            
            // Combo Logic
            comboCounter++;
            clearTimeout(comboTimer);
            comboTimer = setTimeout(() => { comboCounter = 0; updateCombo(); }, 500);
            updateCombo();

            // Crit Logic (Combo increases crit chance)
            let isCrit = Math.random() < (comboCounter * 0.05); // 5% per combo stack
            let dmg = game.clickDmg * (isCrit ? 2 : 1);

            // Particles
            spawnParticles(e.clientX, e.clientY);
            spawnPopup(e.clientX, e.clientY, dmg, isCrit);

            // Haptics
            if(isCrit) tg.HapticFeedback.notificationOccurred('success');
            else tg.HapticFeedback.impactOccurred('light');

            dealDamage(dmg, true);
        }

        function dealDamage(amt, isClick) {
            monster.hp -= amt;
            if(monster.hp <= 0) {
                monster.hp = 0;
                onDeath();
            }
            updateUI();
        }

        function onDeath() {
            // Reward
            const baseGold = Math.floor(monster.maxHp / 3);
            game.gold += monster.isBoss ? baseGold * 5 : baseGold;
            
            // Level Up
            game.lvl++;
            initLevel();
            
            if(monster.isBoss) {
                tg.HapticFeedback.notificationOccurred('success');
                clearInterval(bossTimer);
                document.getElementById('bossTimerBox').style.display = 'none';
            }
        }

        function initLevel() {
            // Check Boss
            const isBoss = game.lvl % 10 === 0;
            monster.isBoss = isBoss;
            
            // Scaling
            const scale = Math.pow(1.2, game.lvl);
            monster.maxHp = Math.floor(20 * scale * (isBoss ? 5 : 1));
            monster.hp = monster.maxHp;

            // Visuals
            const emojis = isBoss ? BOSSES : MONSTERS;
            document.getElementById('monster').textContent = emojis[Math.floor(Math.random()*emojis.length)];
            
            // Boss Logic
            if(isBoss) {
                document.getElementById('bossLabel').style.display = 'block';
                startBossTimer();
            } else {
                document.getElementById('bossLabel').style.display = 'none';
            }

            // Background Change
            document.body.className = game.lvl < 10 ? 'bg-forest' : (game.lvl < 20 ? 'bg-cave' : 'bg-hell');
        }

        function startBossTimer() {
            const time = 30; // seconds
            let left = time;
            document.getElementById('bossTimerBox').style.display = 'block';
            
            bossTimer = setInterval(() => {
                left--;
                document.getElementById('bossTimerBar').style.width = (left/time*100) + '%';
                if(left <= 0) {
                    clearInterval(bossTimer);
                    // Fail
                    monster.hp = monster.maxHp;
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.showAlert("‚ò†Ô∏è –ë–æ—Å—Å –ø–æ–±–µ–¥–∏–ª! –ü–æ–ø—Ä–æ–±—É–π –ø–æ–¥–∫–∞—á–∞—Ç—å—Å—è.");
                    updateUI();
                }
            }, 1000);
        }

        // --- SKILLS ---
        function useSkill() {
            if(skillCooldown > 0) return;
            
            // Skill: ULTIMATE HIT (10x click damage)
            const dmg = game.clickDmg * 20;
            dealDamage(dmg, true);
            spawnPopup(window.innerWidth/2, window.innerHeight/2, "ULTIMAAATE!", true);
            
            // Cooldown 30s
            skillCooldown = 30;
            const btn = document.getElementById('btnSkill');
            btn.classList.remove('ready');
            
            const int = setInterval(() => {
                skillCooldown--;
                document.getElementById('skillCdBar').style.width = ((30-skillCooldown)/30*100) + '%';
                if(skillCooldown <= 0) {
                    clearInterval(int);
                    btn.classList.add('ready');
                }
            }, 1000);
        }

        // --- UPGRADES ---
        function buy(type) {
            if(game.gold >= prices[type]) {
                game.gold -= prices[type];
                
                if(type === 'click') {
                    game.clickDmg += 1;
                    prices.click = Math.floor(prices.click * 1.5);
                } else if(type === 'auto') {
                    game.autoDmg += 2;
                    prices.auto = Math.floor(prices.auto * 1.4);
                } else if(type === 'pet') {
                    if(game.hasPet) return; // one time buy
                    game.hasPet = true;
                    prices.pet = 999999;
                    document.getElementById('upg-pet').classList.add('disabled');
                }
                
                updateUI();
                tg.HapticFeedback.selectionChanged();
            }
        }

        // --- EVENTS ---
        function spawnChest() {
            const chest = document.createElement('div');
            chest.className = 'chest';
            chest.textContent = 'üéÅ';
            document.body.appendChild(chest);
            
            chest.onclick = () => {
                const bonus = game.clickDmg * 50;
                game.gold += bonus;
                spawnPopup(100, 100, `+${bonus} GOLD`, true);
                chest.remove();
                tg.HapticFeedback.notificationOccurred('success');
            };
            
            setTimeout(() => chest.remove(), 5000);
        }

        function spawnParticles(x, y) {
            for(let i=0; i<5; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.setProperty('--mx', (Math.random()-0.5)*100 + 'px');
                p.style.setProperty('--my', (Math.random()-0.5)*100 + 'px');
                p.style.backgroundColor = Math.random() < 0.5 ? '#f59e0b' : '#ef4444';
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 500);
            }
        }

        function spawnPopup(x, y, text, isCrit) {
            const el = document.createElement('div');
            el.className = 'dmg-popup';
            el.textContent = text;
            el.style.left = (x + (Math.random()-0.5)*20) + 'px';
            el.style.top = (y - 50) + 'px';
            if(isCrit) {
                el.style.color = '#ef4444';
                el.style.fontSize = '30px';
                el.style.zIndex = 101;
            }
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }
        
        function updateCombo() {
            const fire = document.getElementById('comboFire');
            fire.style.opacity = comboCounter > 5 ? 1 : 0;
        }

        // --- UI RENDER ---
        function updateUI() {
            document.getElementById('ui-gold').textContent = game.gold;
            document.getElementById('ui-lvl').textContent = game.lvl;
            document.getElementById('ui-dps').textContent = game.autoDmg * (game.hasPet?2:1);
            
            // Monster
            const pct = (monster.hp / monster.maxHp) * 100;
            document.getElementById('hpFill').style.width = pct + '%';
            document.getElementById('hpCur').textContent = Math.floor(monster.hp);
            document.getElementById('hpMax').textContent = monster.maxHp;
            
            // Buttons
            btnState('cost-click', prices.click);
            btnState('cost-auto', prices.auto);
            btnState('cost-pet', prices.pet);
            
            // Pet
            document.getElementById('pet').style.display = game.hasPet ? 'block' : 'none';
        }

        function btnState(id, cost) {
            const btn = document.getElementById(id);
            btn.textContent = cost + ' üí∞';
            btn.parentElement.style.opacity = game.gold >= cost ? 1 : 0.5;
        }

    </script>
</body>
</html>
