<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG 4.0: Loot & Allies</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #09090b;
            --card-bg: #18181b;
            --accent: #eab308; /* Gold */
            --danger: #ef4444;
            --text-main: #f4f4f5;
            --text-sec: #a1a1aa;
            
            /* Rarities */
            --common: #d4d4d8;
            --rare: #3b82f6;
            --epic: #a855f7;
            --legendary: #f59e0b;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* –£–±–∏—Ä–∞–µ—Ç —Å–∏–Ω–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ */
            outline: none;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- UI COMPONENTS --- */
        .header {
            padding: 15px;
            background: var(--card-bg);
            border-bottom: 1px solid #27272a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .currency { display: flex; align-items: center; font-weight: bold; font-size: 18px; color: var(--accent); }
        .currency span { margin-left: 5px; color: #fff; }

        /* --- TABS & NAVIGATION --- */
        .content { flex: 1; overflow-y: auto; position: relative; }
        .tab-view { display: none; height: 100%; padding: 20px; flex-direction: column; }
        .tab-view.active { display: flex; }

        .nav-bar {
            height: 70px;
            background: var(--card-bg);
            border-top: 1px solid #27272a;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .nav-btn {
            background: none; border: none;
            color: var(--text-sec);
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            justify-content: center;
        }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        /* --- BATTLE TAB --- */
        #view-battle { align-items: center; justify-content: center; text-align: center; }
        
        .level-info { font-size: 14px; color: var(--text-sec); margin-bottom: 5px; }
        .progress-container { width: 60%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-bottom: 30px; }
        .progress-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.2s; }

        .monster-wrapper { position: relative; margin-bottom: 40px; }
        .monster { font-size: 140px; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5)); transition: transform 0.05s; cursor: pointer; }
        .monster:active { transform: scale(0.95); }

        .hp-bar-box { width: 80%; }
        .hp-bar { height: 16px; background: #333; border-radius: 8px; overflow: hidden; margin-bottom: 5px; }
        .hp-fill { height: 100%; background: var(--danger); width: 100%; transition: width 0.1s; }

        /* --- ALLIES TAB --- */
        .ally-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            border: 1px solid #27272a;
        }
        .ally-icon { font-size: 30px; margin-right: 15px; width: 40px; text-align: center; }
        .ally-info { flex: 1; }
        .ally-name { font-weight: bold; font-size: 14px; }
        .ally-dps { font-size: 12px; color: var(--text-sec); }
        
        .upgrade-btn {
            background: #27272a;
            border: 1px solid #3f3f46;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
        }
        .upgrade-btn:active { background: #3f3f46; }
        .price-tag { font-size: 11px; color: var(--accent); margin-top: 2px; }

        /* --- HERO TAB (Inventory) --- */
        .hero-stats {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .stat-box .lbl { font-size: 10px; color: var(--text-sec); text-transform: uppercase; }
        .stat-box .val { font-size: 18px; font-weight: bold; }

        /* –°–ª–æ—Ç—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ */
        .equipment-slots { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .equip-slot {
            width: 60px; height: 60px;
            background: #27272a;
            border-radius: 10px;
            border: 2px dashed #3f3f46;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            position: relative;
        }
        .equip-slot.filled { border-style: solid; border-color: var(--accent); background: #3f3f46; }

        /* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .inv-item {
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 1px solid #333;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            position: relative;
        }
        /* –†–∞–º–∫–∏ —Ä–µ–¥–∫–æ—Å—Ç–∏ */
        .rarity-common { border-color: var(--common); box-shadow: inset 0 0 10px rgba(212, 212, 216, 0.1); }
        .rarity-rare { border-color: var(--rare); box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.2); }
        .rarity-legendary { border-color: var(--legendary); box-shadow: inset 0 0 10px rgba(245, 158, 11, 0.3); }

        .inv-lvl { position: absolute; bottom: 2px; right: 2px; font-size: 8px; background: rgba(0,0,0,0.6); padding: 1px 3px; border-radius: 4px; }

        /* --- POPUPS --- */
        .dmg-number { position: absolute; font-weight: 900; font-size: 28px; animation: floatUp 0.6s forwards; text-shadow: 0 0 3px black; pointer-events: none; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

    </style>
</head>
<body>

    <div class="header">
        <div class="currency">üí∞ <span id="ui-gold">0</span></div>
        <div style="font-size:12px; color:#aaa;">RPG 4.0</div>
    </div>

    <div class="content">
        
        <div id="view-battle" class="tab-view active">
            <div class="level-info">LVL <span id="ui-lvl">1</span> ‚Ä¢ Kills <span id="ui-kills">0</span>/10</div>
            <div class="progress-container">
                <div class="progress-fill" id="ui-progress"></div>
            </div>

            <div class="monster-wrapper" onclick="onTap(event)">
                <div class="monster" id="monster">üëæ</div>
            </div>

            <div class="hp-bar-box">
                <div class="hp-bar">
                    <div class="hp-fill" id="hp-fill"></div>
                </div>
                <div style="text-align:center; font-size:12px; color:#aaa;">
                    <span id="hp-cur">100</span> / <span id="hp-max">100</span> HP
                </div>
            </div>
            <div id="boss-warning" style="color:var(--danger); font-weight:bold; margin-top:10px; display:none;">‚ö†Ô∏è BOSS FIGHT ‚ö†Ô∏è</div>
        </div>

        <div id="view-allies" class="tab-view">
            <div style="margin-bottom:15px; color:var(--text-sec); font-size:12px;">–ù–∞–π–º–∏—Ç–µ —Å–æ—é–∑–Ω–∏–∫–æ–≤ –¥–ª—è –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ —É—Ä–æ–Ω–∞</div>
            <div id="allies-list">
                </div>
        </div>

        <div id="view-hero" class="tab-view">
            <div class="hero-stats">
                <div class="stat-box"><div class="lbl">Click DMG</div><div class="val" id="stat-click">1</div></div>
                <div class="stat-box"><div class="lbl">Auto DPS</div><div class="val" id="stat-auto">0</div></div>
            </div>

            <div style="margin-bottom:10px; font-size:12px; color:var(--text-sec);">–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</div>
            <div class="equipment-slots">
                <div class="equip-slot" id="slot-weapon" onclick="unequip('weapon')">üó°Ô∏è</div>
                <div class="equip-slot" id="slot-armor" onclick="unequip('armor')">üõ°Ô∏è</div>
            </div>

            <div style="margin-bottom:10px; font-size:12px; color:var(--text-sec);">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–ö–ª–∏–∫–Ω–∏, —á—Ç–æ–±—ã –Ω–∞–¥–µ—Ç—å)</div>
            <div class="inventory-grid" id="inventory-box">
                </div>
        </div>

    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchTab('battle', this)">
            <div class="nav-icon">‚öîÔ∏è</div>
            <div>–ë–∏—Ç–≤–∞</div>
        </button>
        <button class="nav-btn" onclick="switchTab('allies', this)">
            <div class="nav-icon">‚õ∫</div>
            <div>–õ–∞–≥–µ—Ä—å</div>
        </button>
        <button class="nav-btn" onclick="switchTab('hero', this)">
            <div class="nav-icon">üë§</div>
            <div>–ì–µ—Ä–æ–π</div>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- CONFIG & DATA ---
        
        // –ë–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã —Å–æ—é–∑–Ω–∏–∫–æ–≤
        const ALLY_TYPES = [
            { id: 'soldier', name: "–û–ø–æ–ª—á–µ–Ω–µ—Ü", baseDps: 2, baseCost: 50, icon: "üßë‚Äçüåæ" },
            { id: 'archer', name: "–õ—É—á–Ω–∏–∫", baseDps: 10, baseCost: 300, icon: "üèπ" },
            { id: 'wizard', name: "–ú–∞–≥", baseDps: 50, baseCost: 1500, icon: "üßô‚Äç‚ôÇÔ∏è" },
            { id: 'knight', name: "–†—ã—Ü–∞—Ä—å", baseDps: 200, baseCost: 5000, icon: "üêé" }
        ];

        let game = {
            gold: 0,
            lvl: 1,
            kills: 0, // –£–±–∏–π—Å—Ç–≤ –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ (–Ω—É–∂–Ω–æ 10)
            baseClickDmg: 1,
            
            // –°–æ—é–∑–Ω–∏–∫–∏ { id: level }
            allies: { soldier: 0, archer: 0, wizard: 0, knight: 0 },
            
            // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–µ–¥–º–µ—Ç–æ–≤)
            inventory: [],
            
            // –ù–∞–¥–µ—Ç—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
            equipment: { weapon: null, armor: null }
        };

        let monster = { hp: 10, maxHp: 10, isBoss: false };
        let totalAutoDps = 0;
        let totalClickDmg = 1;

        // --- CORE FUNCTIONS ---

        function init() {
            loadGame();
            renderAllies();
            renderHero();
            calcStats();
            spawnMonster();
            
            // Auto DPS Loop
            setInterval(() => {
                if(totalAutoDps > 0) dealDamage(totalAutoDps);
            }, 1000);

            // Save Loop (Cloud)
            setInterval(saveGame, 30000);
        }

        // --- BATTLE LOGIC ---

        function spawnMonster() {
            // –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è: 10 –º–æ–Ω—Å—Ç—Ä–æ–≤ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å.
            // –ë–æ—Å—Å: –ö–∞–∂–¥—ã–π 5-–π —É—Ä–æ–≤–µ–Ω—å. –ù–∞ —É—Ä–æ–≤–Ω–µ —Å –±–æ—Å—Å–æ–º —É–±–∏–≤–∞–µ–º –¢–û–õ–¨–ö–û –±–æ—Å—Å–∞ (kills = 0/1, –ø–æ —Å—É—Ç–∏).
            
            monster.isBoss = (game.lvl % 5 === 0);
            
            // HP Formula
            let hpScale = Math.pow(1.3, game.lvl);
            monster.maxHp = Math.floor(20 * hpScale);
            
            if (monster.isBoss) {
                monster.maxHp *= 5;
                document.getElementById('boss-warning').style.display = 'block';
                document.getElementById('monster').textContent = "üëπ"; // Boss Icon
                // –î–ª—è –±–æ—Å—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –ø–æ–ª–Ω—ã–π
                document.getElementById('ui-progress').style.width = "100%";
                document.getElementById('ui-kills').innerText = "BOSS";
            } else {
                document.getElementById('boss-warning').style.display = 'none';
                const mobs = ["ü¶†", "üêç", "ü¶á", "üê∫", "üíÄ", "ü¶Ç"];
                document.getElementById('monster').textContent = mobs[Math.floor(Math.random()*mobs.length)];
                
                // Progress Bar
                let pct = (game.kills / 10) * 100;
                document.getElementById('ui-progress').style.width = pct + "%";
                document.getElementById('ui-kills').innerText = game.kills;
            }
            
            monster.hp = monster.maxHp;
            updateHpBar();
        }

        function onTap(e) {
            e.preventDefault();
            dealDamage(totalClickDmg);
            
            // Visuals
            spawnPopup(e.clientX, e.clientY, totalClickDmg);
            const m = document.getElementById('monster');
            m.style.transform = "scale(0.95)";
            setTimeout(() => m.style.transform = "scale(1)", 50);
            tg.HapticFeedback.impactOccurred('light');
        }

        function dealDamage(amt) {
            if (monster.hp <= 0) return;
            monster.hp -= amt;
            if (monster.hp <= 0) {
                monster.hp = 0;
                onDeath();
            }
            updateHpBar();
        }

        function onDeath() {
            // Reward
            let reward = Math.floor(monster.maxHp / 4);
            if (monster.isBoss) reward *= 5;
            game.gold += reward;

            // Drop System (10% chance)
            if (Math.random() < 0.1) dropItem();

            tg.HapticFeedback.notificationOccurred('success');

            // Progression Logic
            if (monster.isBoss) {
                // –£–±–∏–ª–∏ –±–æ—Å—Å–∞ -> –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
                game.lvl++;
                game.kills = 0;
            } else {
                game.kills++;
                if (game.kills >= 10) {
                    game.lvl++;
                    game.kills = 0;
                }
            }
            
            updateUI();
            spawnMonster();
        }

        // --- ALLIES SYSTEM ---

        function renderAllies() {
            const list = document.getElementById('allies-list');
            list.innerHTML = "";
            
            ALLY_TYPES.forEach(type => {
                const lvl = game.allies[type.id];
                const cost = Math.floor(type.baseCost * Math.pow(1.5, lvl));
                const dps = type.baseDps * (lvl || 1); // Display stats

                const div = document.createElement('div');
                div.className = 'ally-card';
                div.innerHTML = `
                    <div class="ally-icon">${type.icon}</div>
                    <div class="ally-info">
                        <div class="ally-name">${type.name} <span style="color:#666">(Lvl ${lvl})</span></div>
                        <div class="ally-dps">+${type.baseDps} DPS/lvl</div>
                    </div>
                    <button class="upgrade-btn" onclick="buyAlly('${type.id}')">
                        <div>UP</div>
                        <div class="price-tag">${cost}üí∞</div>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function buyAlly(id) {
            const type = ALLY_TYPES.find(x => x.id === id);
            const lvl = game.allies[id];
            const cost = Math.floor(type.baseCost * Math.pow(1.5, lvl));

            if (game.gold >= cost) {
                game.gold -= cost;
                game.allies[id]++;
                calcStats();
                renderAllies();
                updateUI();
                tg.HapticFeedback.selectionChanged();
            } else {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // --- INVENTORY & EQUIPMENT SYSTEM ---

        function dropItem() {
            const rarities = [
                { id: 'common', color: 'rarity-common', mult: 1 },
                { id: 'rare', color: 'rarity-rare', mult: 3 },
                { id: 'legendary', color: 'rarity-legendary', mult: 10 }
            ];
            
            // Random Rarity
            let rRand = Math.random();
            let rarity = rarities[0];
            if (rRand > 0.95) rarity = rarities[2]; // 5% legendary
            else if (rRand > 0.75) rarity = rarities[1]; // 20% rare

            // Type
            const isWeapon = Math.random() > 0.5;
            const type = isWeapon ? 'weapon' : 'armor';
            const icon = isWeapon ? "‚öîÔ∏è" : "üõ°Ô∏è";
            
            // Stats based on level
            const val = Math.floor((game.lvl * 2 + 5) * rarity.mult);
            
            const item = {
                id: Date.now() + Math.random(),
                type: type,
                icon: icon,
                val: val,
                rarity: rarity.id,
                css: rarity.color
            };
            
            game.inventory.push(item);
            tg.showAlert(`üéâ –í—ã–ø–∞–ª –ø—Ä–µ–¥–º–µ—Ç!\n${rarity.id.toUpperCase()} ${isWeapon?'–ú–µ—á':'–ë—Ä–æ–Ω—è'} (+${val})`);
            renderHero();
        }

        function renderHero() {
            // Equipment Slots
            renderSlot('slot-weapon', game.equipment.weapon);
            renderSlot('slot-armor', game.equipment.armor);

            // Inventory Grid
            const grid = document.getElementById('inventory-box');
            grid.innerHTML = "";
            
            game.inventory.forEach(item => {
                const el = document.createElement('div');
                el.className = `inv-item ${item.css}`;
                el.innerHTML = `${item.icon}<div class="inv-lvl">+${item.val}</div>`;
                el.onclick = () => equipItem(item);
                grid.appendChild(el);
            });
        }
        
        function renderSlot(elId, item) {
            const el = document.getElementById(elId);
            if (item) {
                el.className = `equip-slot filled ${item.css}`;
                el.innerHTML = item.icon;
            } else {
                el.className = "equip-slot";
                el.innerHTML = elId.includes('weapon') ? "üó°Ô∏è" : "üõ°Ô∏è";
            }
        }

        function equipItem(item) {
            // 1. Remove from inventory
            game.inventory = game.inventory.filter(i => i.id !== item.id);
            
            // 2. Check if something is equipped -> move back to inventory
            if (game.equipment[item.type]) {
                game.inventory.push(game.equipment[item.type]);
            }
            
            // 3. Equip new
            game.equipment[item.type] = item;
            
            calcStats();
            renderHero();
            tg.HapticFeedback.selectionChanged();
        }

        function unequip(slot) {
            if (game.equipment[slot]) {
                game.inventory.push(game.equipment[slot]);
                game.equipment[slot] = null;
                calcStats();
                renderHero();
            }
        }

        // --- UTILS ---

        function calcStats() {
            // Auto DPS (Allies)
            let dps = 0;
            ALLY_TYPES.forEach(t => {
                dps += t.baseDps * game.allies[t.id];
            });
            totalAutoDps = dps;

            // Click DMG (Base + Weapon)
            let click = game.baseClickDmg;
            if (game.equipment.weapon) click += game.equipment.weapon.val;
            
            // Armor adds to click dmg too for simplicity (or could be defensive)
            if (game.equipment.armor) click += game.equipment.armor.val; 
            
            totalClickDmg = click;

            // UI Updates
            document.getElementById('stat-click').innerText = totalClickDmg;
            document.getElementById('stat-auto').innerText = totalAutoDps;
        }

        function updateUI() {
            document.getElementById('ui-gold').innerText = game.gold;
            document.getElementById('ui-lvl').innerText = game.lvl;
        }

        function updateHpBar() {
            const pct = (monster.hp / monster.maxHp) * 100;
            document.getElementById('hp-fill').style.width = pct + "%";
            document.getElementById('hp-cur').innerText = Math.floor(monster.hp);
            document.getElementById('hp-max').innerText = monster.maxHp;
        }

        function spawnPopup(x, y, val) {
            const el = document.createElement('div');
            el.className = 'dmg-number';
            el.innerText = val;
            el.style.left = (x - 20) + 'px';
            el.style.top = (y - 50) + 'px';
            el.style.color = '#fff';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        // --- TABS ---
        window.switchTab = function(tabName, btn) {
            // Hide all tabs
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            // Show target
            document.getElementById('view-' + tabName).classList.add('active');
            btn.classList.add('active');
            
            tg.HapticFeedback.selectionChanged();
        }

        // --- SAVE/LOAD ---
        function saveGame() {
            const data = JSON.stringify(game);
            tg.CloudStorage.setItem('rpg_save_v4', data);
        }

        function loadGame() {
            tg.CloudStorage.getItem('rpg_save_v4', (err, val) => {
                if(!err && val) {
                    try {
                        const saved = JSON.parse(val);
                        // Merge logic can be complex, simple replace for now
                        game = { ...game, ...saved };
                        
                        // Fix if inventory didn't exist in old save
                        if(!game.inventory) game.inventory = [];
                        if(!game.equipment) game.equipment = { weapon: null, armor: null };
                        if(!game.allies) game.allies = { soldier: 0, archer: 0, wizard: 0, knight: 0 };
                        
                        calcStats();
                        renderAllies();
                        renderHero();
                        updateUI();
                    } catch(e) { console.error(e); }
                }
            });
        }

        // START
        init();

    </script>
</body>
</html>
